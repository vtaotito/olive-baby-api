# Olive Baby - Docker Compose for VPS with AI Assistant
# Conecta aos serviços PostgreSQL e Redis existentes no VPS
# Usa rede externa olivebaby-infra_default para infra e olivebaby-network para app

version: '3.8'

services:
  # ==========================================
  # Backend API (Node.js) with AI Assistant
  # ==========================================
  api:
    image: node:20-slim
    container_name: olivebaby-api
    restart: unless-stopped
    working_dir: /app
    entrypoint: /bin/bash
    command:
      - -c
      - |
        apt-get update && apt-get install -y git openssl libssl-dev ca-certificates curl wget postgresql-client
        echo "Cloning repository..."
        rm -rf /app/* /app/.* 2>/dev/null || true
        git clone https://github.com/vtaotito/olive-baby-api.git /tmp/api
        cp -r /tmp/api/* /app/
        rm -rf /tmp/api
        echo "Installing dependencies..."
        npm install --include=dev
        echo "Generating Prisma client..."
        npx prisma generate
        echo "Running migrations..."
        echo "Fixing failed AI migration by creating tables directly..."
        echo "Waiting for PostgreSQL to be ready..."
        until PGPASSWORD="OliveBaby@2024Secure!" psql -h olivebaby-db -U olivebaby -d olivebaby -c "SELECT 1" >/dev/null 2>&1; do sleep 2; done
        echo "PostgreSQL is ready, creating AI tables..."
        PGPASSWORD="OliveBaby@2024Secure!" psql -h olivebaby-db -U olivebaby -d olivebaby -c "CREATE TABLE IF NOT EXISTS ai_chat_sessions (id SERIAL PRIMARY KEY, user_id INTEGER NOT NULL, baby_id INTEGER NOT NULL, title VARCHAR(255), is_active BOOLEAN NOT NULL DEFAULT true, created_at TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP, updated_at TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP, CONSTRAINT ai_chat_sessions_user_id_fkey FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE, CONSTRAINT ai_chat_sessions_baby_id_fkey FOREIGN KEY (baby_id) REFERENCES babies(id) ON DELETE CASCADE);" && echo "✓ ai_chat_sessions table created"
        PGPASSWORD="OliveBaby@2024Secure!" psql -h olivebaby-db -U olivebaby -d olivebaby -c "CREATE INDEX IF NOT EXISTS ai_chat_sessions_user_id_idx ON ai_chat_sessions(user_id); CREATE INDEX IF NOT EXISTS ai_chat_sessions_baby_id_idx ON ai_chat_sessions(baby_id); CREATE INDEX IF NOT EXISTS ai_chat_sessions_user_baby_idx ON ai_chat_sessions(user_id, baby_id);" && echo "✓ Indexes created"
        PGPASSWORD="OliveBaby@2024Secure!" psql -h olivebaby-db -U olivebaby -d olivebaby -c "DO \$\$ BEGIN CREATE TYPE ai_message_role AS ENUM ('user', 'assistant', 'tool', 'system'); EXCEPTION WHEN duplicate_object THEN null; END \$\$;" && echo "✓ ai_message_role type created"
        PGPASSWORD="OliveBaby@2024Secure!" psql -h olivebaby-db -U olivebaby -d olivebaby -c "CREATE TABLE IF NOT EXISTS ai_chat_messages (id SERIAL PRIMARY KEY, session_id INTEGER NOT NULL, role ai_message_role NOT NULL, content TEXT NOT NULL, tool_name VARCHAR(100), tool_payload JSONB, citations JSONB DEFAULT '[]', tokens_used INTEGER, created_at TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP, CONSTRAINT ai_chat_messages_session_id_fkey FOREIGN KEY (session_id) REFERENCES ai_chat_sessions(id) ON DELETE CASCADE);" && echo "✓ ai_chat_messages table created"
        PGPASSWORD="OliveBaby@2024Secure!" psql -h olivebaby-db -U olivebaby -d olivebaby -c "CREATE INDEX IF NOT EXISTS ai_chat_messages_session_id_idx ON ai_chat_messages(session_id); CREATE INDEX IF NOT EXISTS ai_chat_messages_session_created_idx ON ai_chat_messages(session_id, created_at);" && echo "✓ Message indexes created"
        PGPASSWORD="OliveBaby@2024Secure!" psql -h olivebaby-db -U olivebaby -d olivebaby -c "DO \$\$ BEGIN CREATE TYPE ai_insight_severity AS ENUM ('info', 'warning', 'alert'); EXCEPTION WHEN duplicate_object THEN null; END \$\$; DO \$\$ BEGIN CREATE TYPE ai_insight_type AS ENUM ('sleep_pattern', 'feeding_pattern', 'diaper_alert', 'cluster_feeding', 'breast_distribution', 'growth_trend', 'milestone_suggestion', 'routine_anomaly', 'general'); EXCEPTION WHEN duplicate_object THEN null; END \$\$;" && echo "✓ Insight types created"
        PGPASSWORD="OliveBaby@2024Secure!" psql -h olivebaby-db -U olivebaby -d olivebaby -c "CREATE TABLE IF NOT EXISTS ai_insights (id SERIAL PRIMARY KEY, baby_id INTEGER NOT NULL, type ai_insight_type NOT NULL, severity ai_insight_severity NOT NULL DEFAULT 'info', title VARCHAR(255) NOT NULL, explanation TEXT NOT NULL, recommendation TEXT, data JSONB DEFAULT '{}', is_read BOOLEAN NOT NULL DEFAULT false, is_dismissed BOOLEAN NOT NULL DEFAULT false, valid_until TIMESTAMP(3), created_at TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP, CONSTRAINT ai_insights_baby_id_fkey FOREIGN KEY (baby_id) REFERENCES babies(id) ON DELETE CASCADE);" && echo "✓ ai_insights table created"
        PGPASSWORD="OliveBaby@2024Secure!" psql -h olivebaby-db -U olivebaby -d olivebaby -c "CREATE INDEX IF NOT EXISTS ai_insights_baby_id_idx ON ai_insights(baby_id); CREATE INDEX IF NOT EXISTS ai_insights_baby_type_idx ON ai_insights(baby_id, type); CREATE INDEX IF NOT EXISTS ai_insights_severity_idx ON ai_insights(severity); CREATE INDEX IF NOT EXISTS ai_insights_created_idx ON ai_insights(created_at);" && echo "✓ Insight indexes created"
        echo "Resolving failed migration..."
        npx prisma migrate resolve --rolled-back 20251213000001_add_ai_assistant 2>/dev/null || echo "Migration status OK"
        echo "Deploying remaining migrations..."
        npx prisma migrate deploy || echo "Migrations check completed"
        echo "Migrations completed successfully"
        echo "Building application..."
        npm run build
        echo "Starting API server..."
        npm start
    environment:
      NODE_ENV: production
      PORT: 4000
      API_PREFIX: /api/v1
      DATABASE_URL: postgresql://olivebaby:OliveBaby@2024Secure!@olivebaby-db:5432/olivebaby?schema=public
      REDIS_URL: redis://:OliveBabyRedis@2024!@olivebaby-redis:6379
      JWT_ACCESS_SECRET: OliveBabyJWT2024AccessSecretKey32chars!
      JWT_REFRESH_SECRET: OliveBabyJWT2024RefreshSecretKey32ch!
      JWT_ACCESS_EXPIRES_IN: 1h
      JWT_REFRESH_EXPIRES_IN: 7d
      SMTP_HOST: smtp.hostinger.com
      SMTP_PORT: 465
      SMTP_SECURE: "true"
      SMTP_USER: mail@api.oliecare.cloud
      SMTP_PASS: !@Oliver14102025@!
      SMTP_FROM: mail@api.oliecare.cloud
      FRONTEND_URL: https://oliecare.cloud
      RATE_LIMIT_WINDOW_MS: 900000
      RATE_LIMIT_MAX: 100
      # AI Configuration
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      OPENAI_MODEL: ${OPENAI_MODEL:-gpt-4o}
      OPENAI_EMBEDDING_MODEL: ${OPENAI_EMBEDDING_MODEL:-text-embedding-3-small}
      AI_MAX_TOKENS: ${AI_MAX_TOKENS:-2048}
      AI_TEMPERATURE: ${AI_TEMPERATURE:-0.7}
      AI_RAG_TOP_K: ${AI_RAG_TOP_K:-6}
    ports:
      - "4000:4000"
    networks:
      - olivebaby-infra_default
      - olivebaby-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4000/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 180s

  # ==========================================
  # AI Ingest Worker (one-shot)
  # ==========================================
  ai-ingest:
    image: node:20-slim
    container_name: olivebaby-ai-ingest
    working_dir: /app
    entrypoint: /bin/bash
    command:
      - -c
      - |
        apt-get update && apt-get install -y git
        echo "Cloning repository..."
        rm -rf /app/* /app/.* 2>/dev/null || true
        git clone https://github.com/vtaotito/olive-baby-api.git /tmp/api
        cp -r /tmp/api/* /app/
        rm -rf /tmp/api
        npm install --include=dev
        npx prisma generate
        echo "Running AI knowledge base ingestion..."
        npm run ai:ingest
    environment:
      NODE_ENV: production
      DATABASE_URL: postgresql://olivebaby:OliveBaby@2024Secure!@olivebaby-db:5432/olivebaby?schema=public
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      OPENAI_EMBEDDING_MODEL: ${OPENAI_EMBEDDING_MODEL:-text-embedding-3-small}
    depends_on:
      - api
    networks:
      - olivebaby-infra_default
    profiles:
      - ingest

networks:
  olivebaby-infra_default:
    external: true
  olivebaby-network:
    external: true
