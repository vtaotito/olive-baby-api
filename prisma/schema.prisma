// Olive Baby API - Prisma Schema
// Baseado no PLANO_MIGRACAO_NODEJS.md

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ==========================================
// ENUMS
// ==========================================

enum UserRole {
  PARENT
  CAREGIVER
  PEDIATRICIAN
  SPECIALIST
  ADMIN
}

enum Gender {
  FEMALE
  MALE
  OTHER
  NOT_INFORMED
}

enum Relationship {
  MOTHER
  FATHER
  GRANDMOTHER
  GRANDFATHER
  AUNT
  UNCLE
  CAREGIVER
  OTHER
}

enum RegistrationSource {
  BY_CAREGIVER
  SELF_REGISTERED
}

enum ProfessionalStatus {
  PENDING
  INVITED
  ACTIVE
  BLOCKED
}

enum ProfessionalRole {
  PEDIATRICIAN
  OBGYN
  LACTATION_CONSULTANT
  OTHER
}

enum RoutineType {
  FEEDING
  SLEEP
  DIAPER
  BATH
  MILK_EXTRACTION
}

enum BabyMemberType {
  PARENT
  FAMILY
  PROFESSIONAL
}

enum BabyMemberRole {
  OWNER_PARENT_1
  OWNER_PARENT_2
  FAMILY_VIEWER
  FAMILY_EDITOR
  PEDIATRICIAN
  OBGYN
  LACTATION_CONSULTANT
  OTHER
}

enum BabyMemberStatus {
  ACTIVE
  PENDING
  REVOKED
}

enum BabyInviteStatus {
  PENDING
  ACCEPTED
  EXPIRED
  REVOKED
}

// ==========================================
// PLAN & SUBSCRIPTION ENUMS
// ==========================================

enum PlanType {
  FREE
  PREMIUM
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  TRIAL
}

enum UserStatus {
  ACTIVE
  BLOCKED
  PENDING_VERIFICATION
}

enum AuditAction {
  // Plan & Billing
  PAYWALL_HIT
  PLAN_UPGRADED
  PLAN_DOWNGRADED
  SUBSCRIPTION_CREATED
  SUBSCRIPTION_CANCELED
  // Admin actions
  ADMIN_PLAN_CHANGED
  ADMIN_USER_BLOCKED
  ADMIN_USER_UNBLOCKED
  ADMIN_IMPERSONATE_START
  ADMIN_IMPERSONATE_END
  // User actions
  USER_LOGIN
  USER_LOGOUT
  USER_REGISTERED
  USER_PASSWORD_CHANGED
  USER_PROFILE_UPDATED
  // Feature usage
  FEATURE_EXPORT_PDF
  FEATURE_EXPORT_CSV
  FEATURE_AI_CHAT
  FEATURE_BABY_CREATED
  FEATURE_PROFESSIONAL_INVITED
}

// ==========================================
// MODELS
// ==========================================

model User {
  id              Int         @id @default(autoincrement())
  email           String      @unique
  passwordHash    String      @map("password_hash")
  role            UserRole    @default(PARENT)
  status          UserStatus  @default(ACTIVE)
  isActive        Boolean     @default(true) @map("is_active")
  planId          Int?        @map("plan_id")
  lastActivityAt  DateTime?   @map("last_activity_at")
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")
  
  plan            Plan?       @relation(fields: [planId], references: [id])
  subscription    Subscription?
  caregiver       Caregiver?
  professional    Professional?
  refreshTokens   RefreshToken[]
  passwordResets  PasswordReset[]
  chatSessions    AiChatSession[]
  babyMembers     BabyMember[]
  babyInvitesCreated BabyInvite[] @relation("BabyInviteCreatedBy")
  babyMembersRevoked BabyMember[] @relation("BabyMemberRevokedBy")
  settings        UserSettings?
  auditEvents     AuditEvent[]

  @@index([planId])
  @@index([status])
  @@index([lastActivityAt])
  @@map("users")
}

model Caregiver {
  id          Int       @id @default(autoincrement())
  userId      Int       @unique @map("user_id")
  fullName    String    @map("full_name")
  cpf         String    @unique
  phone       String?
  dateOfBirth DateTime? @map("date_of_birth")
  gender      Gender?
  city        String?
  state       String?   @db.Char(2)
  country     String    @default("BR") @db.Char(2)
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  babies      CaregiverBaby[]

  @@map("caregivers")
}

model Baby {
  id               Int       @id @default(autoincrement())
  name             String
  birthDate        DateTime  @map("birth_date")
  city             String?
  state            String?   @db.Char(2)
  country          String    @default("BR") @db.Char(2)
  birthWeightGrams Int?      @map("birth_weight_grams")
  birthLengthCm    Decimal?  @map("birth_length_cm") @db.Decimal(5, 2)
  babyCpfHash      String?   @unique @map("baby_cpf_hash") @db.VarChar(64)
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")
  
  caregivers       CaregiverBaby[]
  professionals    BabyProfessional[]
  members          BabyMember[]
  invites          BabyInvite[]
  routineLogs      RoutineLog[]
  growthRecords    Growth[]
  milestones       Milestone[]
  chatSessions     AiChatSession[]
  insights         AiInsight[]

  @@map("babies")
}

model CaregiverBaby {
  id           Int          @id @default(autoincrement())
  caregiverId  Int          @map("caregiver_id")
  babyId       Int          @map("baby_id")
  relationship Relationship
  isPrimary    Boolean      @default(false) @map("is_primary")
  createdAt    DateTime     @default(now()) @map("created_at")
  
  caregiver    Caregiver    @relation(fields: [caregiverId], references: [id], onDelete: Cascade)
  baby         Baby         @relation(fields: [babyId], references: [id], onDelete: Cascade)
  
  @@unique([caregiverId, babyId])
  @@map("caregiver_babies")
}

model Professional {
  id                 Int                 @id @default(autoincrement())
  userId             Int?                @unique @map("user_id")
  fullName           String              @map("full_name")
  email              String              @unique
  specialty          String
  crmNumber          String?             @map("crm_number")
  crmState           String?             @map("crm_state") @db.Char(2)
  phone              String?
  city               String?
  state              String?             @db.Char(2)
  country            String              @default("BR") @db.Char(2)
  registrationSource RegistrationSource  @default(BY_CAREGIVER) @map("registration_source")
  status             ProfessionalStatus  @default(PENDING)
  inviteToken        String?             @unique @map("invite_token")
  inviteExpiresAt    DateTime?           @map("invite_expires_at")
  createdAt          DateTime            @default(now()) @map("created_at")
  updatedAt          DateTime            @updatedAt @map("updated_at")
  
  user               User?               @relation(fields: [userId], references: [id])
  babies             BabyProfessional[]

  @@map("professionals")
}

model BabyProfessional {
  id             Int              @id @default(autoincrement())
  babyId         Int              @map("baby_id")
  professionalId Int              @map("professional_id")
  role           ProfessionalRole
  notes          String?
  createdAt      DateTime         @default(now()) @map("created_at")
  
  baby           Baby             @relation(fields: [babyId], references: [id], onDelete: Cascade)
  professional   Professional     @relation(fields: [professionalId], references: [id], onDelete: Cascade)
  
  @@unique([babyId, professionalId, role])
  @@map("baby_professionals")
}

model RoutineLog {
  id              Int         @id @default(autoincrement())
  babyId          Int         @map("baby_id")
  routineType     RoutineType @map("routine_type")
  startTime       DateTime    @map("start_time")
  endTime         DateTime?   @map("end_time")
  durationSeconds Int?        @map("duration_seconds")
  notes           String?
  meta            Json?       @db.JsonB
  createdAt       DateTime    @default(now()) @map("created_at")
  
  baby            Baby        @relation(fields: [babyId], references: [id], onDelete: Cascade)
  
  @@index([babyId, startTime])
  @@index([routineType, startTime])
  @@map("routine_logs")
}

model Growth {
  id                  Int       @id @default(autoincrement())
  babyId              Int       @map("baby_id")
  measuredAt          DateTime  @map("measured_at")
  weightKg            Decimal?  @map("weight_kg") @db.Decimal(5, 2)
  heightCm            Decimal?  @map("height_cm") @db.Decimal(5, 2)
  headCircumferenceCm Decimal?  @map("head_circumference_cm") @db.Decimal(5, 2)
  source              String?
  notes               String?
  createdAt           DateTime  @default(now()) @map("created_at")
  
  baby                Baby      @relation(fields: [babyId], references: [id], onDelete: Cascade)
  
  @@index([babyId, measuredAt])
  @@map("growth_records")
}

model Milestone {
  id             Int       @id @default(autoincrement())
  babyId         Int       @map("baby_id")
  milestoneKey   String    @map("milestone_key")
  milestoneLabel String    @map("milestone_label")
  occurredOn     DateTime? @map("occurred_on")
  notes          String?
  createdAt      DateTime  @default(now()) @map("created_at")
  
  baby           Baby      @relation(fields: [babyId], references: [id], onDelete: Cascade)
  
  @@index([babyId, milestoneKey])
  @@map("milestones")
}

model RefreshToken {
  id        Int      @id @default(autoincrement())
  token     String   @unique
  userId    Int      @map("user_id")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@map("refresh_tokens")
}

model PasswordReset {
  id         Int       @id @default(autoincrement())
  userId     Int       @map("user_id")
  tokenHash  String    @unique @map("token_hash") @db.VarChar(64)
  expiresAt  DateTime  @map("expires_at")
  usedAt     DateTime? @map("used_at")
  requestIp  String?   @map("request_ip") @db.VarChar(45)
  userAgent  String?   @map("user_agent") @db.VarChar(500)
  createdAt  DateTime  @default(now()) @map("created_at")
  
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tokenHash])
  @@index([userId, usedAt])
  @@index([expiresAt])
  @@map("password_resets")
}

model UserSettings {
  id                   Int      @id @default(autoincrement())
  userId               Int      @unique @map("user_id")
  
  // Notification preferences
  pushEnabled          Boolean  @default(true) @map("push_enabled")
  emailEnabled         Boolean  @default(false) @map("email_enabled")
  soundEnabled         Boolean  @default(true) @map("sound_enabled")
  
  // Quiet hours
  quietHoursEnabled    Boolean  @default(false) @map("quiet_hours_enabled")
  quietHoursStart      String   @default("22:00") @map("quiet_hours_start") @db.VarChar(5)
  quietHoursEnd        String   @default("07:00") @map("quiet_hours_end") @db.VarChar(5)
  
  // Routine notifications (JSON for flexibility)
  routineNotifications Json     @default("{\"feeding\":true,\"sleep\":true,\"diaper\":false,\"bath\":true,\"extraction\":false}") @map("routine_notifications") @db.JsonB
  
  // Appearance
  theme                String   @default("system") @db.VarChar(20)
  language             String   @default("pt-BR") @db.VarChar(10)
  
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")
  
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("user_settings")
}

// ==========================================
// BABY SHARING MODELS
// ==========================================

model BabyMember {
  id             Int              @id @default(autoincrement())
  babyId         Int              @map("baby_id")
  userId         Int              @map("user_id")
  memberType     BabyMemberType   @map("member_type")
  role           BabyMemberRole
  status         BabyMemberStatus @default(ACTIVE)
  permissions    Json?            @db.JsonB
  createdAt      DateTime         @default(now()) @map("created_at")
  revokedAt      DateTime?        @map("revoked_at")
  revokedByUserId Int?            @map("revoked_by_user_id")
  
  baby           Baby             @relation(fields: [babyId], references: [id], onDelete: Cascade)
  user           User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  revokedBy      User?            @relation("BabyMemberRevokedBy", fields: [revokedByUserId], references: [id])
  
  @@unique([babyId, userId])
  @@index([babyId])
  @@index([userId])
  @@index([babyId, status])
  @@map("baby_members")
}

model BabyInvite {
  id             Int              @id @default(autoincrement())
  babyId         Int              @map("baby_id")
  emailInvited   String           @map("email_invited")
  memberType     BabyMemberType   @map("member_type")
  role           BabyMemberRole
  tokenHash      String           @unique @map("token_hash") @db.VarChar(64)
  expiresAt      DateTime         @map("expires_at")
  status         BabyInviteStatus @default(PENDING)
  invitedName    String?          @map("invited_name")
  message        String?
  createdByUserId Int             @map("created_by_user_id")
  createdAt      DateTime         @default(now()) @map("created_at")
  acceptedAt     DateTime?        @map("accepted_at")
  
  baby           Baby             @relation(fields: [babyId], references: [id], onDelete: Cascade)
  createdBy      User             @relation("BabyInviteCreatedBy", fields: [createdByUserId], references: [id])
  
  @@index([babyId])
  @@index([emailInvited])
  @@index([tokenHash])
  @@index([status])
  @@index([babyId, status])
  @@map("baby_invites")
}

// ==========================================
// AI ASSISTANT MODELS
// ==========================================

enum AiMessageRole {
  user
  assistant
  tool
  system

  @@map("ai_message_role")
}

enum AiInsightSeverity {
  info
  warning
  alert

  @@map("ai_insight_severity")
}

enum AiInsightType {
  sleep_pattern
  feeding_pattern
  diaper_alert
  cluster_feeding
  breast_distribution
  growth_trend
  milestone_suggestion
  routine_anomaly
  general

  @@map("ai_insight_type")
}

model AiDocument {
  id          Int       @id @default(autoincrement())
  source      String    @db.VarChar(500)
  title       String    @db.VarChar(255)
  tags        String[]  @default([])
  metadata    Json?     @default("{}") @db.JsonB
  contentHash String?   @map("content_hash") @db.VarChar(64)
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  chunks      AiChunk[]

  @@index([source])
  @@map("ai_documents")
}

model AiChunk {
  id          Int        @id @default(autoincrement())
  documentId  Int        @map("document_id")
  chunkIndex  Int        @map("chunk_index")
  content     String
  embedding   Unsupported("vector(1536)")?
  metadata    Json?      @default("{}") @db.JsonB
  createdAt   DateTime   @default(now()) @map("created_at")

  document    AiDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([documentId])
  @@map("ai_chunks")
}

model AiChatSession {
  id        Int       @id @default(autoincrement())
  userId    Int       @map("user_id")
  babyId    Int       @map("baby_id")
  title     String?   @db.VarChar(255)
  isActive  Boolean   @default(true) @map("is_active")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  baby      Baby      @relation(fields: [babyId], references: [id], onDelete: Cascade)
  messages  AiChatMessage[]

  @@index([userId])
  @@index([babyId])
  @@index([userId, babyId])
  @@map("ai_chat_sessions")
}

model AiChatMessage {
  id          Int           @id @default(autoincrement())
  sessionId   Int           @map("session_id")
  role        AiMessageRole
  content     String
  toolName    String?       @map("tool_name") @db.VarChar(100)
  toolPayload Json?         @map("tool_payload") @db.JsonB
  citations   Json?         @default("[]") @db.JsonB
  tokensUsed  Int?          @map("tokens_used")
  createdAt   DateTime      @default(now()) @map("created_at")

  session     AiChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([sessionId, createdAt])
  @@map("ai_chat_messages")
}

model AiInsight {
  id             Int               @id @default(autoincrement())
  babyId         Int               @map("baby_id")
  type           AiInsightType
  severity       AiInsightSeverity @default(info)
  title          String            @db.VarChar(255)
  explanation    String
  recommendation String?
  data           Json?             @default("{}") @db.JsonB
  isRead         Boolean           @default(false) @map("is_read")
  isDismissed    Boolean           @default(false) @map("is_dismissed")
  validUntil     DateTime?         @map("valid_until")
  createdAt      DateTime          @default(now()) @map("created_at")

  baby           Baby              @relation(fields: [babyId], references: [id], onDelete: Cascade)

  @@index([babyId])
  @@index([babyId, type])
  @@index([severity])
  @@index([createdAt])
  @@map("ai_insights")
}

// ==========================================
// PLAN & SUBSCRIPTION MODELS
// ==========================================

model Plan {
  id          Int       @id @default(autoincrement())
  name        String    @unique @db.VarChar(50)
  type        PlanType  @unique
  description String?   @db.VarChar(500)
  price       Decimal   @default(0) @db.Decimal(10, 2)
  currency    String    @default("BRL") @db.VarChar(3)
  
  // Limits (JSON for flexibility)
  limits      Json      @default("{\"maxBabies\":1,\"maxProfessionals\":0,\"maxExportsPerMonth\":0,\"historyDays\":7}") @db.JsonB
  
  // Features (JSON for flexibility)
  features    Json      @default("{\"exportPdf\":false,\"exportCsv\":false,\"advancedInsights\":false,\"aiChat\":false,\"multiCaregivers\":false,\"prioritySupport\":false}") @db.JsonB
  
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  
  users         User[]
  subscriptions Subscription[]

  @@map("plans")
}

model Subscription {
  id            Int                 @id @default(autoincrement())
  userId        Int                 @unique @map("user_id")
  planId        Int                 @map("plan_id")
  status        SubscriptionStatus  @default(ACTIVE)
  
  // Payment provider info
  provider      String?             @db.VarChar(50)  // stripe, asaas, manual
  externalId    String?             @map("external_id") @db.VarChar(255)
  
  // Dates
  startedAt     DateTime            @default(now()) @map("started_at")
  currentPeriodStart DateTime?      @map("current_period_start")
  currentPeriodEnd   DateTime?      @map("current_period_end")
  canceledAt    DateTime?           @map("canceled_at")
  endsAt        DateTime?           @map("ends_at")
  
  // Trial info
  trialEndsAt   DateTime?           @map("trial_ends_at")
  
  createdAt     DateTime            @default(now()) @map("created_at")
  updatedAt     DateTime            @updatedAt @map("updated_at")
  
  user          User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan          Plan                @relation(fields: [planId], references: [id])

  @@index([planId])
  @@index([status])
  @@index([externalId])
  @@map("subscriptions")
}

model AuditEvent {
  id          Int         @id @default(autoincrement())
  userId      Int?        @map("user_id")
  action      AuditAction
  targetType  String?     @map("target_type") @db.VarChar(50)  // user, baby, subscription, etc.
  targetId    Int?        @map("target_id")
  metadata    Json?       @default("{}") @db.JsonB
  ipAddress   String?     @map("ip_address") @db.VarChar(45)
  userAgent   String?     @map("user_agent") @db.VarChar(500)
  createdAt   DateTime    @default(now()) @map("created_at")
  
  user        User?       @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([action])
  @@index([targetType, targetId])
  @@index([createdAt])
  @@map("audit_events")
}
