// Olive Baby API - Prisma Schema
// Baseado no PLANO_MIGRACAO_NODEJS.md

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ==========================================
// ENUMS
// ==========================================

enum UserRole {
  PARENT
  CAREGIVER
  PEDIATRICIAN
  SPECIALIST
  ADMIN
}

enum Gender {
  FEMALE
  MALE
  OTHER
  NOT_INFORMED
}

enum Relationship {
  MOTHER
  FATHER
  GRANDMOTHER
  GRANDFATHER
  AUNT
  UNCLE
  CAREGIVER
  OTHER
}

enum RegistrationSource {
  BY_CAREGIVER
  SELF_REGISTERED
}

enum ProfessionalStatus {
  PENDING
  INVITED
  ACTIVE
  BLOCKED
}

enum ProfessionalRole {
  PEDIATRICIAN
  OBGYN
  LACTATION_CONSULTANT
  OTHER
}

enum RoutineType {
  FEEDING
  SLEEP
  DIAPER
  BATH
  MILK_EXTRACTION
}

// ==========================================
// MODELS
// ==========================================

model User {
  id            Int       @id @default(autoincrement())
  email         String    @unique
  passwordHash  String    @map("password_hash")
  role          UserRole  @default(PARENT)
  isActive      Boolean   @default(true) @map("is_active")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  
  caregiver     Caregiver?
  professional  Professional?
  refreshTokens RefreshToken[]
  chatSessions  AiChatSession[]

  @@map("users")
}

model Caregiver {
  id          Int       @id @default(autoincrement())
  userId      Int       @unique @map("user_id")
  fullName    String    @map("full_name")
  cpf         String    @unique
  phone       String?
  dateOfBirth DateTime? @map("date_of_birth")
  gender      Gender?
  city        String?
  state       String?   @db.Char(2)
  country     String    @default("BR") @db.Char(2)
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  babies      CaregiverBaby[]

  @@map("caregivers")
}

model Baby {
  id               Int       @id @default(autoincrement())
  name             String
  birthDate        DateTime  @map("birth_date")
  city             String?
  state            String?   @db.Char(2)
  country          String    @default("BR") @db.Char(2)
  birthWeightGrams Int?      @map("birth_weight_grams")
  birthLengthCm    Decimal?  @map("birth_length_cm") @db.Decimal(5, 2)
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")
  
  caregivers       CaregiverBaby[]
  professionals    BabyProfessional[]
  routineLogs      RoutineLog[]
  growthRecords    Growth[]
  milestones       Milestone[]
  chatSessions     AiChatSession[]
  insights         AiInsight[]

  @@map("babies")
}

model CaregiverBaby {
  id           Int          @id @default(autoincrement())
  caregiverId  Int          @map("caregiver_id")
  babyId       Int          @map("baby_id")
  relationship Relationship
  isPrimary    Boolean      @default(false) @map("is_primary")
  createdAt    DateTime     @default(now()) @map("created_at")
  
  caregiver    Caregiver    @relation(fields: [caregiverId], references: [id], onDelete: Cascade)
  baby         Baby         @relation(fields: [babyId], references: [id], onDelete: Cascade)
  
  @@unique([caregiverId, babyId])
  @@map("caregiver_babies")
}

model Professional {
  id                 Int                 @id @default(autoincrement())
  userId             Int?                @unique @map("user_id")
  fullName           String              @map("full_name")
  email              String              @unique
  specialty          String
  crmNumber          String?             @map("crm_number")
  crmState           String?             @map("crm_state") @db.Char(2)
  phone              String?
  city               String?
  state              String?             @db.Char(2)
  country            String              @default("BR") @db.Char(2)
  registrationSource RegistrationSource  @default(BY_CAREGIVER) @map("registration_source")
  status             ProfessionalStatus  @default(PENDING)
  inviteToken        String?             @unique @map("invite_token")
  inviteExpiresAt    DateTime?           @map("invite_expires_at")
  createdAt          DateTime            @default(now()) @map("created_at")
  updatedAt          DateTime            @updatedAt @map("updated_at")
  
  user               User?               @relation(fields: [userId], references: [id])
  babies             BabyProfessional[]

  @@map("professionals")
}

model BabyProfessional {
  id             Int              @id @default(autoincrement())
  babyId         Int              @map("baby_id")
  professionalId Int              @map("professional_id")
  role           ProfessionalRole
  notes          String?
  createdAt      DateTime         @default(now()) @map("created_at")
  
  baby           Baby             @relation(fields: [babyId], references: [id], onDelete: Cascade)
  professional   Professional     @relation(fields: [professionalId], references: [id], onDelete: Cascade)
  
  @@unique([babyId, professionalId, role])
  @@map("baby_professionals")
}

model RoutineLog {
  id              Int         @id @default(autoincrement())
  babyId          Int         @map("baby_id")
  routineType     RoutineType @map("routine_type")
  startTime       DateTime    @map("start_time")
  endTime         DateTime?   @map("end_time")
  durationSeconds Int?        @map("duration_seconds")
  notes           String?
  meta            Json?       @db.JsonB
  createdAt       DateTime    @default(now()) @map("created_at")
  
  baby            Baby        @relation(fields: [babyId], references: [id], onDelete: Cascade)
  
  @@index([babyId, startTime])
  @@index([routineType, startTime])
  @@map("routine_logs")
}

model Growth {
  id                  Int       @id @default(autoincrement())
  babyId              Int       @map("baby_id")
  measuredAt          DateTime  @map("measured_at")
  weightKg            Decimal?  @map("weight_kg") @db.Decimal(5, 2)
  heightCm            Decimal?  @map("height_cm") @db.Decimal(5, 2)
  headCircumferenceCm Decimal?  @map("head_circumference_cm") @db.Decimal(5, 2)
  source              String?
  notes               String?
  createdAt           DateTime  @default(now()) @map("created_at")
  
  baby                Baby      @relation(fields: [babyId], references: [id], onDelete: Cascade)
  
  @@index([babyId, measuredAt])
  @@map("growth_records")
}

model Milestone {
  id             Int       @id @default(autoincrement())
  babyId         Int       @map("baby_id")
  milestoneKey   String    @map("milestone_key")
  milestoneLabel String    @map("milestone_label")
  occurredOn     DateTime? @map("occurred_on")
  notes          String?
  createdAt      DateTime  @default(now()) @map("created_at")
  
  baby           Baby      @relation(fields: [babyId], references: [id], onDelete: Cascade)
  
  @@index([babyId, milestoneKey])
  @@map("milestones")
}

model RefreshToken {
  id        Int      @id @default(autoincrement())
  token     String   @unique
  userId    Int      @map("user_id")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@map("refresh_tokens")
}

model PasswordReset {
  id        Int      @id @default(autoincrement())
  email     String
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  used      Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")

  @@index([email])
  @@map("password_resets")
}

// ==========================================
// AI ASSISTANT MODELS
// ==========================================

enum AiMessageRole {
  user
  assistant
  tool
  system

  @@map("ai_message_role")
}

enum AiInsightSeverity {
  info
  warning
  alert

  @@map("ai_insight_severity")
}

enum AiInsightType {
  sleep_pattern
  feeding_pattern
  diaper_alert
  cluster_feeding
  breast_distribution
  growth_trend
  milestone_suggestion
  routine_anomaly
  general

  @@map("ai_insight_type")
}

model AiDocument {
  id          Int       @id @default(autoincrement())
  source      String    @db.VarChar(500)
  title       String    @db.VarChar(255)
  tags        String[]  @default([])
  metadata    Json?     @default("{}") @db.JsonB
  contentHash String?   @map("content_hash") @db.VarChar(64)
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  chunks      AiChunk[]

  @@index([source])
  @@map("ai_documents")
}

model AiChunk {
  id          Int        @id @default(autoincrement())
  documentId  Int        @map("document_id")
  chunkIndex  Int        @map("chunk_index")
  content     String
  embedding   Unsupported("vector(1536)")?
  metadata    Json?      @default("{}") @db.JsonB
  createdAt   DateTime   @default(now()) @map("created_at")

  document    AiDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([documentId])
  @@map("ai_chunks")
}

model AiChatSession {
  id        Int       @id @default(autoincrement())
  userId    Int       @map("user_id")
  babyId    Int       @map("baby_id")
  title     String?   @db.VarChar(255)
  isActive  Boolean   @default(true) @map("is_active")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  baby      Baby      @relation(fields: [babyId], references: [id], onDelete: Cascade)
  messages  AiChatMessage[]

  @@index([userId])
  @@index([babyId])
  @@index([userId, babyId])
  @@map("ai_chat_sessions")
}

model AiChatMessage {
  id          Int           @id @default(autoincrement())
  sessionId   Int           @map("session_id")
  role        AiMessageRole
  content     String
  toolName    String?       @map("tool_name") @db.VarChar(100)
  toolPayload Json?         @map("tool_payload") @db.JsonB
  citations   Json?         @default("[]") @db.JsonB
  tokensUsed  Int?          @map("tokens_used")
  createdAt   DateTime      @default(now()) @map("created_at")

  session     AiChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([sessionId, createdAt])
  @@map("ai_chat_messages")
}

model AiInsight {
  id             Int               @id @default(autoincrement())
  babyId         Int               @map("baby_id")
  type           AiInsightType
  severity       AiInsightSeverity @default(info)
  title          String            @db.VarChar(255)
  explanation    String
  recommendation String?
  data           Json?             @default("{}") @db.JsonB
  isRead         Boolean           @default(false) @map("is_read")
  isDismissed    Boolean           @default(false) @map("is_dismissed")
  validUntil     DateTime?         @map("valid_until")
  createdAt      DateTime          @default(now()) @map("created_at")

  baby           Baby              @relation(fields: [babyId], references: [id], onDelete: Cascade)

  @@index([babyId])
  @@index([babyId, type])
  @@index([severity])
  @@index([createdAt])
  @@map("ai_insights")
}
